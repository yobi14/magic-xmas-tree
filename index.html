<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>✨ 魔法粒子圣诞树 ✨</title>
    <style>
        body { margin: 0; background: radial-gradient(circle at center, #050510 0%, #000 100%); overflow: hidden; font-family: sans-serif; color: #fff; }
        canvas { position: absolute; top: 0; left: 0; display: block; }
        #video { position: absolute; bottom: 10px; right: 10px; width: 120px; height: 90px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); transform: scaleX(-1); opacity: 0.1; pointer-events: none; }
        #status { position: absolute; top: 20%; width: 100%; text-align: center; font-size: 1.2rem; color: gold; text-shadow: 0 0 15px rgba(255,215,0,0.7); z-index: 10; padding: 0 20px; box-sizing: border-box; }
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .2em 0 0 rgba(0,0,0,0), .4em 0 0 rgba(0,0,0,0); } 40% { color: gold; text-shadow: .2em 0 0 rgba(0,0,0,0), .4em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .2em 0 0 gold, .4em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .2em 0 0 gold, .4em 0 0 gold; } }
    </style>
</head>
<body>

    <div id="status">魔法加载中，请允许摄像头权限<span class="loading-dots"></span></div>
    <video id="video" playsinline></video>
    <canvas id="canvas"></canvas>

    <script src="https://unpkg.com/@mediapipe/hands/hands.js"></script>
    <script src="https://unpkg.com/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusText = document.getElementById('status');

        let width, height;
        let particles = [];
        let fingerX = -1000, fingerY = -1000;
        let isFingerDetected = false;

        function resize() {
            width = canvasElement.width = window.innerWidth;
            height = canvasElement.height = window.innerHeight;
            initParticles();
        }
        window.addEventListener('resize', resize);
        resize();

        // 粒子系统
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.baseColor = color;
                this.size = Math.random() * 1.5 + 0.5;
                this.blinkSpeed = Math.random() * 0.05 + 0.02;
                this.light = 0;
            }
            draw() {
                const dx = fingerX - this.x;
                const dy = fingerY - this.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (isFingerDetected && dist < 100) {
                    this.light = Math.min(this.light + 0.2, 1);
                } else {
                    this.light *= 0.9;
                }

                const s = Math.sin(Date.now() * this.blinkSpeed + this.x);
                const opacity = 0.3 + (s + 1) * 0.3 + this.light;
                
                canvasCtx.beginPath();
                canvasCtx.arc(this.x, this.y, this.size + this.light * 2, 0, Math.PI*2);
                canvasCtx.fillStyle = this.light > 0.5 ? '#fff' : this.baseColor;
                canvasCtx.globalAlpha = Math.min(opacity, 1);
                if (this.light > 0.1) {
                    canvasCtx.shadowBlur = 10 * this.light;
                    canvasCtx.shadowColor = "#fff";
                }
                canvasCtx.fill();
                canvasCtx.shadowBlur = 0;
            }
        }

        function initParticles() {
            particles = [];
            const centerX = width / 2;
            const treeHeight = Math.min(height * 0.7, 500);
            const bottom = height * 0.8;

            for (let i = 0; i < 4000; i++) {
                const rY = Math.random();
                const h = rY * treeHeight;
                const maxWidth = (h / treeHeight) * (treeHeight * 0.5);
                const x = centerX + (Math.random() - 0.5) * 2 * maxWidth;
                const y = bottom - h;
                const color = `hsl(${120 + Math.random() * 40}, 100%, ${20 + Math.random() * 30}%)`;
                particles.push(new Particle(x, y, color));
            }
        }

        function drawStar() {
            canvasCtx.globalAlpha = 1;
            canvasCtx.font = "50px serif";
            canvasCtx.textAlign = "center";
            canvasCtx.shadowBlur = 20;
            canvasCtx.shadowColor = "gold";
            canvasCtx.fillText("⭐", width/2, height * 0.8 - Math.min(height * 0.7, 500) - 20);
            canvasCtx.shadowBlur = 0;
        }

        function animate() {
            canvasCtx.globalAlpha = 1;
            canvasCtx.clearRect(0, 0, width, height);
            drawStar();
            particles.forEach(p => p.draw());
            requestAnimationFrame(animate);
        }

        // 初始化 Mediapipe
        const hands = new Hands({
            locateFile: (file) => `https://unpkg.com/@mediapipe/hands@0.4.1646424515/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults((results) => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const point = results.multiHandLandmarks[0][8];
                fingerX = (1 - point.x) * width;
                fingerY = point.y * height;
                isFingerDetected = true;
                statusText.style.display = 'none';
            } else {
                isFingerDetected = false;
            }
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });

        // 超时检测
        let timeout = setTimeout(() => {
            if (statusText.style.display !== 'none') {
                statusText.innerHTML = "加载较慢，请检查：<br>1. 网络环境<br>2. 是否使用了 HTTPS<br>3. 刷新重试";
            }
        }, 12000);

        camera.start().then(() => {
            statusText.innerText = "加载成功！请伸出食指";
            animate();
        }).catch(err => {
            statusText.innerText = "摄像头无法启动，请确保在 HTTPS 环境下打开";
        });
    </script>
</body>
</html>
