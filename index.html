<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mac Chrome 魔法圣诞树</title>
    <style>
        body { margin: 0; background: #000; color: #fff; overflow: hidden; font-family: sans-serif; }
        canvas { position: absolute; top: 0; left: 0; z-index: 1; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; pointer-events: none; }
        #status { background: rgba(0,0,0,0.8); padding: 15px 30px; border-radius: 50px; border: 1px solid gold; color: gold; text-align: center; }
        #btn-start { margin-top: 20px; padding: 15px 40px; background: gold; color: #000; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; pointer-events: auto; display: none; box-shadow: 0 0 20px gold; }
        #video { position: absolute; bottom: 10px; right: 10px; width: 160px; height: 120px; border: 2px solid #333; transform: scaleX(-1); z-index: 5; background: #222; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="status">正在同步魔法资源 (WASM)...</div>
        <button id="btn-start" onclick="initCamera()">立即开启摄像头</button>
    </div>
    
    <video id="video" playsinline></video>
    <canvas id="canvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        const statusEl = document.getElementById('status');
        const btnStart = document.getElementById('btn-start');
        const videoEl = document.getElementById('video');
        const canvasEl = document.getElementById('canvas');
        const ctx = canvasEl.getContext('2d');

        let hands, camera, fingerX = -100, fingerY = -100, active = false;

        // 基础绘制循环 (让树先显示)
        function draw() {
            ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
            const centerX = canvasEl.width / 2;
            const bottom = canvasEl.height * 0.8;
            
            // 绘制星星
            ctx.font = "50px serif"; ctx.textAlign = "center";
            ctx.shadowBlur = active ? 25 : 5; ctx.shadowColor = "gold";
            ctx.fillText("⭐", centerX, bottom - 420);

            // 绘制粒子树 (简化版)
            for(let i=0; i<2000; i++) {
                const h = Math.random() * 400;
                const w = (h/400) * 200;
                const px = centerX + (Math.random()-0.5)*2*w;
                const py = bottom - h;
                
                const dist = Math.sqrt((px-fingerX)**2 + (py-fingerY)**2);
                const isNear = active && dist < 80;
                
                ctx.fillStyle = isNear ? "#fff" : `hsl(120, 100%, ${20 + Math.random()*20}%)`;
                ctx.globalAlpha = isNear ? 1 : 0.4;
                ctx.beginPath();
                ctx.arc(px, py, isNear ? 3 : 1.5, 0, Math.PI*2);
                ctx.fill();
            }
            requestAnimationFrame(draw);
        }

        // 初始化资源
        window.onload = () => {
            canvasEl.width = window.innerWidth;
            canvasEl.height = window.innerHeight;
            
            try {
                hands = new Hands({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
                });
                hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });
                hands.onResults(res => {
                    if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                        const p = res.multiHandLandmarks[0][8];
                        fingerX = (1 - p.x) * canvasEl.width;
                        fingerY = p.y * canvasEl.height;
                        active = true;
                    } else { active = false; }
                });
                
                statusEl.innerText = "✅ 魔法资源就绪";
                btnStart.style.display = "block";
                draw();
            } catch (e) {
                statusEl.innerText = "❌ 资源加载失败: " + e.message;
            }
        };

        async function initCamera() {
            statusEl.innerText = "正在请求摄像头权限...";
            btnStart.style.display = "none";
            
            camera = new Camera(videoEl, {
                onFrame: async () => { await hands.send({image: videoEl}); },
                width: 640, height: 480
            });

            camera.start()
                .then(() => { statusEl.style.display = "none"; })
                .catch(err => {
                    statusEl.innerText = "❌ 摄像头开启失败！请在 Chrome 地址栏左侧开启权限并刷新。";
                    console.error(err);
                });
        }
    </script>
</body>
</html>
