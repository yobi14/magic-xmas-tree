<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ¨ é­”æ³•åœ£è¯æ ‘ (ç¨³å®šç‰ˆ) âœ¨</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        canvas { position: absolute; top: 0; left: 0; }
        #video { position: absolute; width: 1px; height: 1px; opacity: 0; }
        #status {
            position: absolute; top: 40%; width: 100%; text-align: center;
            color: #ffd700; font-size: 1.1rem; z-index: 100;
            background: rgba(0,0,0,0.6); padding: 10px 0;
        }
        #btn-start {
            position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; background: gold; color: #000; border: none;
            border-radius: 25px; font-weight: bold; cursor: pointer; display: none; z-index: 101;
        }
    </style>
</head>
<body>

    <div id="status">ğŸ”® æ­£åœ¨å”¤é†’é­”æ³• (ä¸‹è½½èµ„æºä¸­)...</div>
    <button id="btn-start" onclick="startMagic()">ç‚¹å‡»å¼€å¯é­”æ³•</button>
    <video id="video" playsinline></video>
    <canvas id="canvas"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424515/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        const statusText = document.getElementById('status');
        const startBtn = document.getElementById('btn-start');
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');

        let width, height, particles = [];
        let fingerX = -100, fingerY = -100, isDetected = false;

        function resize() {
            width = canvasElement.width = window.innerWidth;
            height = canvasElement.height = window.innerHeight;
            initTree();
        }
        window.addEventListener('resize', resize);
        resize();

        function initTree() {
            particles = [];
            const centerX = width / 2;
            const treeH = Math.min(height * 0.6, 500);
            const bottom = height * 0.8;
            for (let i = 0; i < 3000; i++) {
                const r = Math.random();
                const h = r * treeH;
                const w = (h / treeH) * (treeH * 0.5);
                particles.push({
                    x: centerX + (Math.random() - 0.5) * 2 * w,
                    y: bottom - h,
                    c: `hsl(${120 + Math.random() * 40}, 100%, ${20 + Math.random() * 30}%)`,
                    s: Math.random() * 2,
                    o: Math.random()
                });
            }
        }

        function draw() {
            canvasCtx.clearRect(0, 0, width, height);
            // ç”»æ˜Ÿæ˜Ÿ
            canvasCtx.font = "40px serif";
            canvasCtx.textAlign = "center";
            canvasCtx.shadowBlur = 15; canvasCtx.shadowColor = "gold";
            canvasCtx.fillText("â­", width/2, height * 0.8 - Math.min(height * 0.6, 500) - 20);
            
            particles.forEach(p => {
                const dx = fingerX - p.x;
                const dy = fingerY - p.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const isNear = isDetected && dist < 80;

                canvasCtx.globalAlpha = isNear ? 1 : p.o;
                canvasCtx.fillStyle = isNear ? "#fff" : p.c;
                canvasCtx.beginPath();
                canvasCtx.arc(p.x, p.y, isNear ? p.s + 2 : p.s, 0, Math.PI*2);
                canvasCtx.fill();
            });
            requestAnimationFrame(draw);
        }

        // åˆå§‹åŒ–æ‰‹åŠ¿è¯†åˆ«
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424515/${file}`
        });

        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });
        hands.onResults(results => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const point = results.multiHandLandmarks[0][8];
                fingerX = (1 - point.x) * width;
                fingerY = point.y * height;
                isDetected = true;
            } else { isDetected = false; }
        });

        // æ ¸å¿ƒï¼šå¤„ç†æ‘„åƒå¤´å’Œåº“çš„åŠ è½½
        async function startMagic() {
            startBtn.style.display = 'none';
            statusText.innerText = "æ­£åœ¨å”¤èµ·ç›¸æœº...";
            const camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 640, height: 480
            });
            camera.start().then(() => {
                statusText.style.display = "none";
            }).catch(() => {
                statusText.innerText = "âŒ ç›¸æœºå¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®æˆ–ä½¿ç”¨å…¶ä»–æµè§ˆå™¨";
            });
        }

        // æ£€æŸ¥åŠ è½½çŠ¶æ€
        window.onload = () => {
            let checkLoad = setInterval(() => {
                // å¦‚æœ Hands åº“åŠ è½½æˆåŠŸï¼Œé€šå¸¸å®ƒä¼šæŒ‚è½½åœ¨ window ä¸Š
                if (typeof Hands !== 'undefined') {
                    clearInterval(checkLoad);
                    statusText.innerText = "âœ… èµ„æºå·²å°±ç»ª";
                    startBtn.style.display = "block";
                    draw(); // å…ˆå¼€å§‹ç”»æ ‘
                }
            }, 500);
        };
    </script>
</body>
</html>
